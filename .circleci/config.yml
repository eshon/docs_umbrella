version: 2
jobs:
  build:
    docker:
      - image: circleci/node:stretch 
    # On Github Webhook for Wiki updates from eshon/testwikisync_doc repo, trigger a 
    # git submodule update in this repo, copy files to docs/ folder and push to this repo
    # so eshon.github.io/docs_umbrella Docsify can be rebuilt
    # TODO - Edits from this repo trigger copy to testwikidocs/ repo and push back to eshon/testwikisync_doc 
    #
    # Also see https://github.com/eshon/docs_umbrella/blob/master/docs/index.html for custom Docsify renderer
    # for Github Wiki markdown for images
    steps:
      - run:
          name: Install rsync
          command: 'sudo apt-get update && sudo apt-get -y install rsync'
      - run:
          name: Update npm
          command: 'sudo npm install -g npm@latest'
      - run:
          name: Install docsify
          command: 'sudo npm i docsify-cli -g'
      - checkout
      - run:
          name: 'Update the submodule'
          command: 'git submodule update --init --recursive --remote'
      - run:
          name: Copy wiki over to docs - exclude images and .git file
          command: 'rsync -av --progress testwikidocs docs --exclude images --exclude "*.git"'
      - run:
          name: Copy wiki's images folder to docs/_images
          command: 'rsync -av --progress testwikidocs/images docs/_images'
      - run:
          name: Show contents of docs
          command: 'ls -la docs'
      - run:
          name: config credential helper
          command: 'git config credential.helper "cache --timeout=120"'
      - run:
          name: config user email
          command: 'git config user.email ${GH_EMAIL}'
      - run:
          name: config user name
          command: 'git config user.name ${GH_NAME}'
      - run:
          name: add new files in docs/ directory
          command: 'git add docs'
      - run:
          name: commit files
          command: 'git commit --allow-empty -m "Pushing from CI"'
      - run:
          name: push files quietly to avoid showing token in logs
          command: 'git push -q https://${DOCS_GH_TOKEN}@github.com/eshon/docs_umbrella.git master'
                    
