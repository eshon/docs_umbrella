version: 2
jobs:
  build:
    docker:
      - image: circleci/node:latest 
    # Triggers: Updates to this repo will trigger this CI script and any edits to the
    # Github Wiki in the eshon/testwikisync_doc repo will trigger this via Github webhook.
    # Github Wiki Markdown files and image files (but not folder names) in submodule and docs should be identical
    #
    # Also see https://github.com/eshon/docs_umbrella/blob/master/docs/index.html for custom Docsify renderer
    # for Github Wiki markdown for images
    #
    steps:
      - run:
          name: Install rsync
          command: 'sudo apt-get update && sudo apt-get -y install rsync'
      - run:
          name: Update npm
          command: 'sudo npm install -g npm@latest'
      - run:
          name: Install docsify
          command: 'sudo npm i docsify-cli -g'
      - checkout
      - run:
          name: 'Update the submodule'
          command: 'git submodule update --init --recursive --remote'
      - run:
          name: Get timestamps of this repo and submodule
          command: |
            export DOCS_COMMIT_TIME=$(git show -s --format=%ct)
            export WIKI_COMMIT_TIME=$(git show -s --format=%ct)
            echo $WIKI_COMMIT_TIME
            echo $DOCS_COMMIT_TIME
            [ "${DOCS_COMMIT_TIME}" -gt "${WIKI_COMMIT_TIME}" ] && echo "Docs is newer"
            [ "${WIKI_COMMIT_TIME}" -gt "${DOCS_COMMIT_TIME}" ] && echo "Wiki is newer"
            if [ "${DOCS_COMMIT_TIME}" -gt "${WIKI_COMMIT_TIME}" ]
            then
                echo 'docs is newer so copy to wiki' 
            fi
      - run:
          name: Copy wiki over to docs - exclude images and .git file
          command: 'rsync -av --progress --exclude images --exclude "*.git" testwikidocs/* docs/'
      - run:
          name: Copy wiki's images folder to docs/_images
          command: 'rsync -av --progress testwikidocs/images/* docs/_images/'
      - run:
          name: Show contents of docs
          command: 'ls -la docs'
      - run:
          name: config credential helper
          command: 'git config credential.helper "cache --timeout=120"'
      - run:
          name: config user email
          command: 'git config --global user.email ${GH_EMAIL}'
      - run:
          name: config user name
          command: 'git config --global user.name ${GH_NAME}'
      - run:
          name: add new files in docs/ directory
          command: 'git add docs'
      - run:
          name: commit files
          command: 'git commit --allow-empty -m "Pushing from Wiki webhook via CI [skip ci]"'
      - run:
          name: Update docs
          command: 'git pull origin master'
      - run:
          name: push files quietly to avoid showing token in logs, might fail on merge conflict
          command: 'git push -q https://${DOCS_GH_TOKEN}@github.com/eshon/docs_umbrella.git master'
      - run:
          name: diff docs and submodule, if there are differences need to push to Wiki...
          command: |
            export DIFFTAG=$(diff -r -x '.*' -x '*.html' -x 'images' -x '_images' -x '_*.md' docs/ testwikidocs/ | wc -l)
            echo $DIFFTAG
            if [ "${DIFFTAG}" -ne "0" ]; then
              echo "Need to update Wiki"
              cd testwikidocs
              git pull origin master
              git checkout -b wiki_changes
              rsync -av --progress --exclude _images --exclude '*.git' --exclude '*.nojekyll' --exclude '*.html' --exclude '_*.md' ../docs/* .
              rsync -av --progress ../docs/_images/* images/
              git add .
              git commit -m "Pushing from Docs repo to Wiki via CI [skip ci]"
              git checkout master
              git merge wiki_changes
              git push -q https://${DOCS_GH_TOKEN}@github.com/eshon/testwikidocs_sync.git master
            fi

                    
